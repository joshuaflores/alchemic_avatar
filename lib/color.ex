defmodule AlchemicAvatar.Color do
  @palettes [:google, :iwanthue]

  def from_name(username) do
    colors_palette = AlchemicAvatar.Config.colors_palette

		username = username |> strip_special_chars()

    if colors_palette in @palettes do
      apply(AlchemicAvatar.Color, colors_palette, [username])
    else
      apply(AlchemicAvatar.Color, :google, [username])
    end
  end

  def google(username) do
    index = do_google_username(username)
    google_tuple() |> elem(index)
  end

  def iwanthue(username) do
    len = tuple_size(iwanthue_tuple())
    index = username |> hexdigest |> digest_to_index(len)
    iwanthue_tuple() |> elem(index)
  end

 # def randomcolor(username) do
		##lent
	#end

	def strip_special_chars(username) do
		username
		|> String.normalize(:nfd)
		|> String.replace(~r/[^A-z\s]/u, "")
		|> String.trim()
		|> String.upcase
	end

  defp do_google_username(username) do
    case username do
      <<char, _rest::binary>> when char in 97..122 ->
       char - 32 - 65
      <<char, _rest::binary>> when char in 65..90 ->
       char - 65
      <<char, _rest::binary>> when char in 48..57 ->
       <<char>> |> String.to_integer
      <<string::binary>> ->
        len = tuple_size(google_tuple())
        string |> hexdigest |> digest_to_index(len)
    end
  end

  defp hexdigest(data) when is_binary(data) do
    data |> :erlang.md5 |> Base.encode16(case: :lower)
  end

  defp digest_to_index(data, len) when is_binary(data) do
    data |> String.slice(0..15) |> String.to_integer(16) |> rem(len)
  end

  defp google_tuple do
    {
			#[226, 95, 81], # A
      #[242, 96, 145], # B
      #[187, 101, 202], # C
      #[149, 114, 207], # D
      #[120, 132, 205], # E
      #[91, 149, 249], # F
      #[72, 194, 249], # G
      #[69, 208, 226], # H
      #[72, 182, 172], # I
      #[82, 188, 137], # J
      #[155, 206, 95], # K
      #[212, 227, 74], # L
      #[254, 218, 16], # M
      #[247, 192, 0], # N
      #[255, 168, 0], # O
      #[255, 138, 96], # P
      #[194, 194, 194], # Q
      #[143, 164, 175], # R
      #[162, 136, 126], # S
      #[163, 163, 163], # T
      #[175, 181, 226], # U
      #[179, 155, 221], # V
      #[194, 194, 194], # W
      #[124, 222, 235], # X
      #[188, 170, 164], # Y
      #[173, 214, 125] # Z
			[76, 217, 100],
			[68, 175, 105],
			[155, 197, 61],
			[27, 153, 139],
			[55, 119, 113],
			[63, 97, 169],
			[255, 142, 132],
			[242, 93, 93],
			[238, 99, 82],
			[255, 142, 114],
			[12, 206, 107],
			[203, 186, 237],
			[91, 133, 170],
			[169, 63, 85],
			[253, 231, 76],
			[255, 149, 58],
			[255, 160, 96],
			[79, 109, 122],
			[89, 203, 89],
			[39, 143, 207],
			[252, 171, 16],
			[100, 93, 215],
			[49, 133, 252],
			[63, 167, 214],
			[46, 196, 182],
			[77, 157, 224],
    }
  end

  defp old_iwanthue_tuple do
    {
     [198,125,40],
     [61,155,243],
     [74,243,75],
     [238,89,166],
     [52,240,224],
     [177,156,155],
     [240,120,145],
     [111,154,78],
     [237,179,245],
     [237,101,95],
     [89,239,155],
     [43,254,70],
     [163,212,245],
     [65,152,142],
     [165,135,246],
     [181,166,38],
     [187,229,206],
     [77,164,25],
     [179,246,101],
     [234,93,37],
     [225,155,115],
     [142,140,188],
     [223,120,140],
     [249,174,27],
     [244,117,225],
     [137,141,102],
     [75,191,146],
     [188,239,142],
     [164,199,145],
     [173,120,149],
     [59,195,89],
     [222,198,220],
     [68,145,187],
     [236,204,179],
     [159,195,72],
     [188,121,189],
     [166,160,85],
     [181,233,37],
     [236,177,85],
     [121,147,160],
     [234,218,110],
     [241,157,191],
     [62,200,234],
     [133,243,34],
     [88,149,110],
     [59,228,248],
     [183,119,118],
     [251,195,45],
     [113,196,122],
     [197,115,70],
     [80,175,187],
     [103,231,238],
     [240,72,133],
     [228,149,241],
     [180,188,159],
     [172,132,85],
     [180,135,251],
     [236,194,58],
     [217,176,109],
     [88,244,199],
     [186,157,239],
     [113,230,96],
     [206,115,165],
     [244,178,163],
     [230,139,26],
     [241,125,89],
     [83,160,66],
     [107,190,166],
     [197,161,210],
     [198,203,245],
     [238,117,19],
     [228,119,116],
     [131,156,41],
     [145,178,168],
     [139,170,220],
     [233,95,125],
     [87,178,230],
     [157,200,119],
     [237,140,76],
     [229,185,186],
     [144,206,212],
     [236,209,158],
     [185,189,79],
     [34,208,66],
     [84,238,129],
     [133,140,134],
     [67,157,94],
     [168,179,25],
     [140,145,240],
     [151,241,125],
     [67,162,107],
     [200,156,21],
     [169,173,189],
     [226,116,189],
     [133,231,191],
     [194,161,63],
     [241,77,99],
     [241,217,53],
     [123,204,105],
     [210,201,119],
     [229,108,155],
     [240,91,72],
     [187,115,210],
     [240,163,100],
     [178,217,57],
     [179,135,116],
     [204,211,24],
     [186,135,57],
     [223,176,135],
     [204,148,151],
     [116,223,50],
     [95,195,46],
     [123,160,236],
     [181,172,131],
     [142,220,202],
     [240,140,112],
     [172,145,164],
     [228,124,45],
     [135,151,243],
     [42,205,125],
     [192,233,116],
     [119,170,114],
     [158,138,26],
     [73,190,183],
     [185,229,243],
     [227,107,55],
     [196,205,202],
     [132,143,60],
     [233,192,237],
     [62,150,220],
     [205,201,141],
     [106,140,190],
     [161,131,205],
     [135,134,158],
     [198,139,81],
     [115,171,32],
     [101,181,67],
     [149,137,119],
     [37,142,183],
     [183,130,175],
     [168,125,133],
     [124,142,87],
     [236,156,171],
     [232,194,91],
     [219,200,69],
     [144,219,34],
     [219,95,187],
     [145,154,217],
     [165,185,100],
     [127,238,163],
     [224,178,198],
     [119,153,120],
     [124,212,92],
     [172,161,105],
     [231,155,135],
     [157,132,101],
     [122,185,146],
     [53,166,51],
     [70,163,90],
     [150,190,213],
     [210,107,60],
     [166,152,185],
     [159,194,159],
     [39,141,222],
     [202,176,161],
     [95,140,229],
     [168,142,87],
     [93,170,203],
     [159,142,54],
     [14,168,39],
     [94,150,149],
     [187,206,136],
     [157,224,166],
     [235,158,208],
     [109,232,216],
     [141,201,87],
     [208,124,118],
     [142,125,214],
     [19,237,174],
     [72,219,41],
     [234,102,111],
     [168,142,79],
     [188,135,35],
     [95,155,143],
     [148,173,116],
     [223,112,95],
     [228,128,236],
     [206,114,54],
     [195,119,88],
     [235,140,94],
     [235,202,125],
     [233,155,153],
     [214,214,238],
     [246,200,35],
     [151,125,171],
     [132,145,172],
     [131,142,118],
     [199,126,150],
     [61,162,123],
     [58,176,151],
     [215,141,69],
     [225,154,220],
     [220,77,167],
     [233,161,64],
     [130,221,137],
     [81,191,129],
     [169,162,140],
     [174,177,222],
     [236,174,47],
     [233,188,180],
     [69,222,172],
     [71,232,93],
     [118,211,238],
     [157,224,83],
     [218,105,73],
     [126,169,36]
    }
  end

  defp iwanthue_tuple do
		# Generated by randomColor.js
		# Seed 7, hue: random
		{
			#[121, 226, 247],
			#[148, 201, 239],
			#[183, 205, 244],
			#[11, 26, 142],
			#[39, 26, 124],
			#[140, 82, 242],
			#[183, 110, 229],
			#[220, 143, 234],
			#[242, 179, 237],
			#[193, 13, 133],
			#[239, 47, 131],
			#[229, 75, 106],
			#[229, 111, 105],
			#[232, 163, 136],
			#[242, 210, 176],
			#[242, 189, 14],
			#[237, 237, 42],
			#[178, 214, 59],
			#[151, 214, 83],
			#[140, 216, 110],
			#[159, 249, 154],
			#[7, 198, 46],
			#[28, 188, 97],
			#[53, 196, 150],
			#[76, 201, 191],


			[174, 244, 149],
			[165, 252, 164],
			[174, 252, 191],
			[117, 244, 174],
			[125, 242, 207],
			[134, 239, 232],
			[169, 238, 252],
			[179, 220, 249],
			[196, 216, 252],
			[112, 126, 229],
			[138, 124, 226],
			[186, 149, 249],
			[215, 163, 247],
			[236, 178, 247],
			[252, 196, 247],
			[234, 112, 193],
			[252, 136, 186],
			[249, 149, 169],
			[247, 167, 163],
			[247, 195, 175],
			[252, 224, 194],
			[249, 219, 119],
			[249, 249, 129],
			[219, 244, 134],
			[194, 242, 142],
			[183, 247, 158],
			[175, 252, 171],
			[115, 244, 141],
			[123, 242, 174],
			[133, 242, 207],
			[141, 239, 231],
			[174, 238, 249],
			[189, 225, 249],
			[107, 152, 229],
			[118, 132, 226],
			[158, 146, 252],
			[191, 159, 249],
			[216, 173, 247],
			[239, 187, 249],
			[237, 109, 228],
			[252, 131, 216],
			[249, 144, 192],
			[247, 155, 175],
			[247, 171, 170],
			[249, 204, 187],
			[252, 184, 116],
			[249, 219, 127],
			[247, 245, 136],
			[222, 244, 141],
			[201, 244, 151],
			[192, 252, 166],
			[183, 255, 178],
		}
  end
end
